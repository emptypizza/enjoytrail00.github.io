<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>kmm adventure (total: Stage 3 )</title>
    <style>
        /* --- Í∏∞Î≥∏ Ïä§ÌÉÄÏùº --- */
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* Ìó§Îçî */
        .header {
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #1e1e1e;
            font-weight: bold;
            font-size: 1.1rem;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .highlight { color: #00e5ff; }
        .key-text { color: #ffd700; display: none; } 

        /* ÎØ∏ÏÖò Î∞î */
        .mission-bar {
            width: 100%;
            background-color: #333;
            color: #ffeb3b;
            text-align: center;
            padding: 8px 0;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        /* Í≤åÏûÑ Î≥¥Îìú */
        #game-board {
            display: grid;
            width: 90vw;
            height: 90vw;
            max-width: 380px;
            max-height: 380px;
            margin: 20px 0;
            border: 4px solid #444;
            background-color: #000;
            position: relative;
        }

        .cell {
            border: 1px solid #222;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Ïò§Î∏åÏ†ùÌä∏ Ïä§ÌÉÄÏùº */
        .painted {
            background-color: #00bcd4;
            box-shadow: 0 0 5px #00bcd4;
            border: 1px solid #4dd0e1;
            transition: background-color 0.1s;
        }

        .player {
            background-color: #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 10px #ffffff;
            z-index: 10;
            width: 70%;
            height: 70%;
        }

        .enemy {
            background-color: #ff3d00;
            border-radius: 15%;
            box-shadow: 0 0 10px #ff3d00;
            z-index: 5;
            width: 70%;
            height: 70%;
            transition: all 0.2s ease-in-out;
        }

        .gold-key {
            width: 60%;
            height: 60%;
            background-color: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 15px #ffd700;
            z-index: 8;
            animation: key-lifetime 3s forwards;
        }

        @keyframes key-lifetime {
            0% { opacity: 0; transform: scale(0.5); }
            10% { opacity: 1; transform: scale(1); }
            70% { opacity: 1; transform: scale(1); }
            80% { opacity: 0.5; }
            90% { opacity: 1; }
            100% { opacity: 0; transform: scale(0); }
        }

        /* Ïª®Ìä∏Î°§Îü¨ */
        .controls-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            background-color: #181818;
            padding-bottom: 10px;
        }

        .d-pad {
            display: grid;
            grid-template-columns: 80px 80px 80px;
            grid-template-rows: 80px 80px;
            gap: 10px;
        }

        .btn {
            background-color: #333;
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 0 #111;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .btn:active {
            background-color: #555;
            box-shadow: 0 2px 0 #111;
            transform: translateY(3px);
        }

        /* Ïò§Î≤ÑÎ†àÏù¥ */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        
        button.action-btn {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 1.4rem;
            background: #00e5ff;
            color: #000;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 0 15px #00e5ff;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="header">
        <div>STAGE: <span id="stage-num" class="highlight">1</span></div>
        <div>TIME: <span id="time-display" class="highlight">60</span></div>
        <div id="key-container" class="key-text">KEY: <span id="key-display">0/3</span></div>
        <div>PAINT: <span id="score-display" class="highlight">0%</span></div>
    </div>

    <div id="mission-text" class="mission-bar">
        üéØ ÎØ∏ÏÖò Î°úÎî© Ï§ë...
    </div>

    <div id="game-board"></div>

    <div class="controls-area">
        <div class="d-pad">
            <div></div> 
            <button class="btn" onpointerdown="handleInput(0, -1, event)">‚ñ≤</button>
            <div></div> 
            <button class="btn" onpointerdown="handleInput(-1, 0, event)">‚óÄ</button>
            <button class="btn" onpointerdown="handleInput(0, 1, event)">‚ñº</button>
            <button class="btn" onpointerdown="handleInput(1, 0, event)">‚ñ∂</button>
        </div>
    </div>

    <div id="overlay">
        <h1 id="result-title" style="font-size: 2.5rem; margin: 0; text-align:center;">GAME OVER</h1>
        <p id="result-desc" style="color:#aaa; font-size: 1.1rem; margin-top:10px;">Try again!</p>
        <button id="overlay-btn" class="action-btn" onclick="handleOverlayClick()">RESTART</button>
    </div>

    <script>
        /* --- Ïò§ÎîîÏò§ ÏãúÏä§ÌÖú --- */
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'move') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.05);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } 
            else if (type === 'spawn') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
            else if (type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, now);
                osc.frequency.setValueAtTime(1600, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            }
            else if (type === 'win') {
                osc.type = 'square';
                gainNode.gain.value = 0.1;
                osc.frequency.setValueAtTime(523.25, now); 
                osc.frequency.setValueAtTime(659.25, now + 0.1); 
                osc.frequency.setValueAtTime(783.99, now + 0.2); 
                osc.frequency.setValueAtTime(1046.50, now + 0.4); 
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                osc.start(now);
                osc.stop(now + 0.8);
            }
            else if (type === 'lose') {
                osc.type = 'sawtooth';
                gainNode.gain.value = 0.1;
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            }
        }

        /* --- Ïä§ÌÖåÏù¥ÏßÄ ÏÑ§Ï†ï (3Îã®Í≥Ñ Ï∂îÍ∞ÄÎê®) --- */
        const STAGES = [
            {
                level: 1,
                gridSize: 8,
                goalPercent: 70,
                goalKeys: 0, 
                enemies: 1,
                time: 45,
                missionText: "1Îã®Í≥Ñ: Ï†ÅÏùÑ ÌîºÌï¥ 70%Î•º Ïπ†ÌïòÏÑ∏Ïöî!"
            },
            {
                level: 2,
                gridSize: 10,
                goalPercent: 70,
                goalKeys: 3, 
                enemies: 3, 
                time: 70,
                missionText: "2Îã®Í≥Ñ: Ïó¥Ïá† 3Í∞ú ÏàòÏßë + 70% Ï†êÎ†π!"
            },
            {
                level: 3, // ‚òÖ FINAL STAGE
                gridSize: 10, // Îßµ ÌÅ¨Í∏∞ Ïú†ÏßÄ
                goalPercent: 70,
                goalKeys: 3, // Ïó¥Ïá† Í∏∞ÎØπ Ïú†ÏßÄ
                enemies: 8,  // ‚òÖ Ï†Å 8Î™Ö (ÏßÄÏò• ÎÇúÏù¥ÎèÑ)
                time: 90,    // ÏãúÍ∞Ñ Îçî Ï§å
                missionText: "‚òÖFINAL: Ï†Å 8Î™Ö ÏÉùÏ°¥ + Ïó¥Ïá† 3Í∞ú!"
            }
        ];

        let currentStageIdx = 0;
        let config;
        let player = { x: 0, y: 0 };
        let enemies = [];
        let paintedSet = new Set();
        let currentKeys = 0;
        let activeKey = null;
        
        let isPlaying = false;
        let timeLeft = 0;
        let timers = { main: null, enemy: null, spawn: null, keyLife: null };
        let lastInputTime = 0;

        const boardEl = document.getElementById('game-board');
        const overlay = document.getElementById('overlay');
        const ui = {
            stage: document.getElementById('stage-num'),
            time: document.getElementById('time-display'),
            score: document.getElementById('score-display'),
            keyBox: document.getElementById('key-container'),
            keyText: document.getElementById('key-display'),
            mission: document.getElementById('mission-text'),
            title: document.getElementById('result-title'),
            desc: document.getElementById('result-desc'),
            btn: document.getElementById('overlay-btn')
        };

        function initStage(stageIdx) {
            config = STAGES[stageIdx];
            currentStageIdx = stageIdx;

            ui.stage.innerText = config.level;
            ui.mission.innerText = config.missionText;
            
            if (config.goalKeys > 0) {
                ui.keyBox.style.display = 'block';
                ui.keyBox.style.color = '#ffd700';
            } else {
                ui.keyBox.style.display = 'none';
            }

            boardEl.innerHTML = '';
            boardEl.style.gridTemplateColumns = `repeat(${config.gridSize}, 1fr)`;
            boardEl.style.gridTemplateRows = `repeat(${config.gridSize}, 1fr)`;
            for(let i=0; i<config.gridSize*config.gridSize; i++) {
                let div = document.createElement('div');
                div.classList.add('cell');
                div.id = `cell-${i%config.gridSize}-${Math.floor(i/config.gridSize)}`;
                boardEl.appendChild(div);
            }

            startGame();
        }

        function startGame() {
            player = { x: 0, y: 0 };
            enemies = [];
            
            // ‚òÖ Ï†Å 8Î™Ö Ïä§Ìè∞ Î°úÏßÅ (ÎûúÎç§ + ÏïàÏ†ÑÍ±∞Î¶¨ ÌôïÎ≥¥)
            // ÌîåÎ†àÏù¥Ïñ¥(0,0) Í∑ºÏ≤òÏóêÎäî ÏÉùÏÑ±ÎêòÏßÄ ÏïäÎèÑÎ°ù Ìï®
            while(enemies.length < config.enemies) {
                let ex = Math.floor(Math.random() * config.gridSize);
                let ey = Math.floor(Math.random() * config.gridSize);
                
                // ÌîåÎ†àÏù¥Ïñ¥ÏôÄ Í±∞Î¶¨ Í≥ÑÏÇ∞ (Îß®Ìï¥Ìäº Í±∞Î¶¨)
                let dist = Math.abs(ex - player.x) + Math.abs(ey - player.y);
                
                // Ïù¥ÎØ∏ ÏûàÎäî ÏúÑÏπòÏù∏ÏßÄ ÌôïÏù∏
                let overlap = enemies.some(e => e.x === ex && e.y === ey);

                // ÏïàÏ†Ñ Í±∞Î¶¨(4Ïπ∏ Ïù¥ÏÉÅ) ÌôïÎ≥¥ÎêòÎ©¥ Î∞∞Ïπò
                if (dist > 4 && !overlap) {
                    enemies.push({ x: ex, y: ey });
                }
            }

            paintedSet.clear();
            paintedSet.add(`0,0`);
            currentKeys = 0;
            timeLeft = config.time;
            activeKey = null;
            isPlaying = true;
            overlay.style.display = 'none';

            clearAllTimers();

            updateView();
            updateUI();

            timers.main = setInterval(() => {
                timeLeft--;
                updateUI();
                if(timeLeft <= 0) gameOver(false);
            }, 1000);

            // Ï†Å Ïù¥Îèô (3Ïä§ÌÖåÏù¥ÏßÄÎäî 8Î™ÖÏù¥ÎØÄÎ°ú ÏïΩÍ∞Ñ ÎäêÎ¶¨Í≤å 0.7Ï¥à, ÏïÑÎãàÎ©¥ ÎÑàÎ¨¥ Ïñ¥Î†§ÏõÄ)
            let moveSpeed = config.enemies > 5 ? 700 : 600;
            timers.enemy = setInterval(moveEnemies, moveSpeed);

            if (config.goalKeys > 0) {
                timers.spawn = setInterval(trySpawnKey, 1000);
            }
        }

        function clearAllTimers() {
            clearInterval(timers.main);
            clearInterval(timers.enemy);
            clearInterval(timers.spawn);
            clearTimeout(timers.keyLife);
        }

        /* --- Í≤åÏûÑ Î°úÏßÅ --- */
        function trySpawnKey() {
            if (!isPlaying || activeKey !== null || currentKeys >= config.goalKeys) return;
            
            let percent = paintedSet.size / (config.gridSize*config.gridSize);
            let chance = 0.1 + (percent * 0.4); 

            if (Math.random() < chance) {
                let kx = Math.floor(Math.random() * config.gridSize);
                let ky = Math.floor(Math.random() * config.gridSize);
                activeKey = { x: kx, y: ky };
                playSound('spawn');
                updateView();

                timers.keyLife = setTimeout(() => {
                    if (activeKey) {
                        activeKey = null;
                        updateView();
                    }
                }, 3000);
            }
        }

        window.handleInput = function(dx, dy, event) {
            if(event) event.preventDefault();
            const now = Date.now();
            if (now - lastInputTime < 150) return;
            lastInputTime = now;
            
            if (audioCtx.state === 'suspended') audioCtx.resume();

            movePlayer(dx, dy);
        }

        function movePlayer(dx, dy) {
            if(!isPlaying) return;
            let nx = player.x + dx;
            let ny = player.y + dy;

            if(nx >= 0 && nx < config.gridSize && ny >= 0 && ny < config.gridSize) {
                player.x = nx;
                player.y = ny;
                
                if (!paintedSet.has(`${nx},${ny}`)) {
                    playSound('move');
                }
                paintedSet.add(`${nx},${ny}`);

                if (activeKey && nx === activeKey.x && ny === activeKey.y) {
                    currentKeys++;
                    activeKey = null;
                    clearTimeout(timers.keyLife);
                    playSound('coin');
                }

                checkCollision();
                updateView();
                updateUI();
                checkWin();
            }
        }

        function moveEnemies() {
            if(!isPlaying) return;
            enemies.forEach(enemy => {
                let dx = 0, dy = 0;
                if(Math.random() > 0.5) { // 50% Ï∂îÏ†Å
                    if(player.x > enemy.x) dx = 1;
                    else if(player.x < enemy.x) dx = -1;
                    else if(player.y > enemy.y) dy = 1;
                    else if(player.y < enemy.y) dy = -1;
                } else {
                    const dirs = [[0,1], [0,-1], [1,0], [-1,0]];
                    const rand = dirs[Math.floor(Math.random() * dirs.length)];
                    dx = rand[0]; dy = rand[1];
                }
                let nx = enemy.x + dx;
                let ny = enemy.y + dy;
                
                // Îßµ Î∞ñÏúºÎ°ú Ïïà ÎÇòÍ∞ÄÍ≤å
                if(nx >= 0 && nx < config.gridSize && ny >= 0 && ny < config.gridSize) {
                    enemy.x = nx;
                    enemy.y = ny;
                }
            });
            checkCollision();
            updateView();
        }

        function checkCollision() {
            for(let e of enemies) {
                if (player.x === e.x && player.y === e.y) {
                    gameOver(false);
                    return;
                }
            }
        }

        function checkWin() {
            let total = config.gridSize * config.gridSize;
            let percent = Math.floor((paintedSet.size / total) * 100);
            
            if (percent >= config.goalPercent && currentKeys >= config.goalKeys) {
                gameOver(true);
            }
        }

        function gameOver(isWin) {
            isPlaying = false;
            clearAllTimers();
            overlay.style.display = 'flex';

            if (isWin) {
                playSound('win');
                if (currentStageIdx < STAGES.length - 1) {
                    // Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ
                    ui.title.innerText = "STAGE CLEAR!";
                    ui.title.style.color = "#00e5ff";
                    ui.desc.innerText = "Next Challenge Awaits!";
                    ui.btn.innerText = "NEXT STAGE >>";
                    ui.btn.onclick = () => initStage(currentStageIdx + 1);
                } else {
                    // ÏóîÎî©
                    ui.title.innerText = "LEGENDARY!";
                    ui.title.style.color = "#ffd700";
                    ui.desc.innerText = "You survived the Hell Mode!";
                    ui.btn.innerText = "PLAY AGAIN";
                    ui.btn.onclick = () => initStage(0);
                }
            } else {
                playSound('lose');
                ui.title.innerText = "FAILED";
                ui.title.style.color = "#ff3d00";
                ui.desc.innerText = "Trapped by enemies...";
                ui.btn.innerText = "RETRY STAGE";
                ui.btn.onclick = () => startGame();
            }
        }

        /* --- Î∑∞ Î†åÎçîÎßÅ --- */
        function updateView() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => { c.className = 'cell'; c.innerHTML = ''; });

            paintedSet.forEach(k => {
                let [cx, cy] = k.split(',');
                let el = document.getElementById(`cell-${cx}-${cy}`);
                if(el) el.classList.add('painted');
            });

            if (activeKey) {
                let el = document.getElementById(`cell-${activeKey.x}-${activeKey.y}`);
                if (el) {
                    let k = document.createElement('div');
                    k.className = 'gold-key';
                    el.appendChild(k);
                }
            }

            let pEl = document.getElementById(`cell-${player.x}-${player.y}`);
            if(pEl) {
                let p = document.createElement('div');
                p.className = 'player';
                pEl.appendChild(p);
            }

            enemies.forEach(e => {
                let el = document.getElementById(`cell-${e.x}-${e.y}`);
                if(el) {
                    let en = document.createElement('div');
                    en.className = 'enemy';
                    el.appendChild(en);
                }
            });
        }

        function updateUI() {
            ui.time.innerText = timeLeft;
            let total = config.gridSize * config.gridSize;
            let percent = Math.floor((paintedSet.size / total) * 100);
            ui.score.innerText = `${percent}%`;

            if (config.goalKeys > 0) {
                ui.keyText.innerText = `${currentKeys}/${config.goalKeys}`;
                if (currentKeys >= config.goalKeys) ui.keyBox.style.color = '#00ff00';
            }

            if (timeLeft <= 10) ui.time.style.color = 'red';
            else ui.time.style.color = '#00e5ff';
        }

        function handleOverlayClick() {
            // initStageÏóêÏÑú onclick Ïû¨Ï†ïÏùò
        }

        // ÏµúÏ¥à Ïã§Ìñâ
        initStage(0);

    </script>
</body>
</html>
